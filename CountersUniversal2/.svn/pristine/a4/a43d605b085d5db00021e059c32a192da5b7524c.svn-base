using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using System.Runtime.InteropServices.WindowsRuntime;
using Windows.Foundation;
using Windows.Foundation.Collections;
using Windows.UI.Xaml;
using Windows.UI.Xaml.Controls;
using Windows.UI.Xaml.Controls.Primitives;
using Windows.UI.Xaml.Data;
using Windows.UI.Xaml.Input;
using Windows.UI.Xaml.Media;
using Windows.UI.Xaml.Navigation;
using Windows.UI.Popups;
using SQLite;
using Windows.ApplicationModel.Store;
using Windows.Phone.UI.Input;

namespace Counters
{
    public sealed partial class MainPage : Page
    {
        private AppSettings _settings;
        private Task _task;

        public MainPage()
        {
            this.InitializeComponent();
            mainMenu.InitializeDrawerLayout();
            mainMenu.OpenDrawer();
            HardwareButtons.BackPressed += HardwareButtons_BackPressed;
        }

        protected async override void OnNavigatedTo(NavigationEventArgs e)
        {
            _settings = Resources["settings"] as AppSettings;
            if (_settings.NotRated && _settings.Runs == 4)
            {
                MessageDialog msgbox = new MessageDialog("Вы пользуетесь приложением уже достаточно долго. Не могли бы Вы оставить о нем отзыв?");

                msgbox.Commands.Add(new UICommand("Да", async c =>
                {
                    await Windows.System.Launcher.LaunchUriAsync(new Uri("ms-windows-store:reviewapp?appid=" + CurrentApp.AppId));
                    _settings.NotRated = false;
                }));
                msgbox.Commands.Add(new UICommand("Нет"));

                await msgbox.ShowAsync();

                _settings.Runs = 0;
            }

            if (CurrentApp.LicenseInformation.ProductLicenses["FullVersion"].IsActive)
                _settings.IsFullVersion = true;
        }

        private async void Page_Loaded(object sender, RoutedEventArgs e)
        {
            // Переходим на стартовую страницу
            await frameContent.NavigateAsync(Type.GetType(_settings.DefaultPageType));
            // Регистрируем фоновую задачу
            await BackgroundTaskManager.RegisterBackgroundTask();

            if (!_settings.IsFullVersion)
                return;

            var backups = await LiveLogin.GetOrderedBackups();
            if (backups != null && backups.First().CreationDate > DateTime.Parse(_settings.LastBackupDate))
            {
                var msgbox = new MessageDialog("Обнаружена новая резервная копия. Восстановить данные?");

                msgbox.Commands.Add(new UICommand("Да", async c =>
                {
                    var appBar = frameContent.CurrentPage.Page.BottomAppBar;
                    if (appBar != null)
                        appBar.Visibility = Visibility.Collapsed;

                    _task = new OneDriveHelper().RestoreAsync();
                    await _task;

                    if (appBar != null)
                        appBar.Visibility = Visibility.Visible;
                }));
                msgbox.Commands.Add(new UICommand("Нет"));

                await msgbox.ShowAsync();
                _settings.LastBackupDate = backups.First().CreationDate.ToString();
            }
        }

        private void btnMainMenu_Tapped(object sender, TappedRoutedEventArgs e)
        {
            if (mainMenu.IsDrawerOpen)
                mainMenu.CloseDrawer();
            else
                mainMenu.OpenDrawer();
        }

        private void frameContent_Navigated(object sender, MyToolkit.Paging.MtNavigationEventArgs e)
        {
            if (mainMenu.IsDrawerOpen)
                mainMenu.CloseDrawer();

            var addPages = new List<Type> { typeof(AddCounter), typeof(AddData), typeof(AddFlat), typeof(AddNotification), typeof(AddScore), typeof(AddService) };
            var notAddPage = addPages.IndexOf(frameContent.CurrentPage.Type) == -1;
            mainMenu.IsDrawerVisible = notAddPage;
            btnMainMenu.Visibility = notAddPage ? Visibility.Visible : Visibility.Collapsed;

            var currentFlat = global.db.Query<Flat>("select * From Flat where FlatID=?", _settings.CurrentFlatId).FirstOrDefault();
            if (currentFlat == null)
            {
                currentFlat = global.db.Query<Flat>("select * From Flat").FirstOrDefault();
                _settings.CurrentFlatId = currentFlat.FlatId;
            }
            btnFlats.Text = currentFlat.Name;
            var header = frameContent.CurrentPage.Page.Tag;
            if (header != null)
                tbHeader.Text = header.ToString();
        }

        private async void btnFlats_Tapped(object sender, TappedRoutedEventArgs e)
        {
            await frameContent.NavigateAsync(typeof(Flats));
        }

        private async void grdData_Tapped(object sender, TappedRoutedEventArgs e)
        {
            mainMenu.CloseDrawer();
            frameContent.IsEnabled = true;

            var selectedItem = (sender as Grid).DataContext as MainMenuItem;
            await frameContent.NavigateAsync(Type.GetType(selectedItem.Page));
            if (selectedItem.IsLocked)
            {
                frameContent.IsEnabled = false;
                await new MessageDialog("Данный раздел доступен только в полной версии приложения.").ShowAsync();
            }
        }

        private async void HardwareButtons_BackPressed(object sender, BackPressedEventArgs e)
        {
            e.Handled = true;

            if (_task != null && !_task.IsCompleted)
                return;

            if (mainMenu.IsDrawerOpen)
                mainMenu.CloseDrawer();
            else if (frameContent.CanGoBack && !frameContent.IsNavigating)
                try
                {
                    await frameContent.GoBackAsync();
                }
                catch { }
            else
            {
                var msgbox = new MessageDialog("Вы действительно хотите выйти?");

                msgbox.Commands.Add(new UICommand("Да", c => Application.Current.Exit()));
                msgbox.Commands.Add(new UICommand("Нет"));

                await msgbox.ShowAsync();
            }
        }

        private void btnExit_Tapped(object sender, TappedRoutedEventArgs e)
        {
            Application.Current.Exit();
        }
    }
}
