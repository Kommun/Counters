using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Runtime.InteropServices.WindowsRuntime;
using Windows.Foundation;
using Windows.Foundation.Collections;
using Windows.UI.Xaml;
using Windows.UI.Xaml.Controls;
using Windows.UI.Xaml.Controls.Primitives;
using Windows.UI.Xaml.Data;
using Windows.UI.Xaml.Input;
using Windows.UI.Xaml.Media;
using Windows.UI.Xaml.Navigation;
using Windows.UI.Popups;

namespace Counters
{

    public sealed partial class Data : MyToolkit.Paging.MtPage
    {
        int id;
        QueryResult selectedData;
        List<QueryResult> datas;

        public Data()
        {
            this.InitializeComponent();
        }

        private void lbData_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (lbData.SelectedItem != null)
                selectedData = lbData.SelectedItem as QueryResult;
            btnChange.IsEnabled = lbData.SelectedIndex != -1;
        }

        protected override void OnNavigatedTo(MyToolkit.Paging.MtNavigationEventArgs e)
        {
            id = (int)e.Parameter;
            Tag = global.db.Get<Counter>(id).Name;
            refresh();
        }

        private void refresh()
        {
            datas = global.db.Query<QueryResult>("select * from Counter join CounterData on Counter.CounterId=CounterData.CounterId"
                + " join Tarif on CounterData.TariffId=Tarif.TariffId where Counter.CounterId=?", id);
            lbData.ItemsSource = datas.Reverse<QueryResult>();
            btnDelete.IsEnabled = datas.Count() > 1;
        }

        private async void btnAdd_Click(object sender, RoutedEventArgs e)
        {
            await Frame.NavigateAsync(typeof(AddData), new AddDataParameter()
             {
                 CounterId = id,
                 ScoreId = 0,
                 DataId = 0
             });
        }

        private async void btnDelete_Click(object sender, RoutedEventArgs e)
        {
            var lastData = datas.Last();
            if (lastData.ScoreId != 0)
            {
                MessageDialog msgbox = new MessageDialog("Показания привязаны к счету. Удалить их?");

                msgbox.Commands.Add(new UICommand("Да", null, 0));
                msgbox.Commands.Add(new UICommand("Нет", null, 1));

                var res = await msgbox.ShowAsync();
                if (res == null || (int)res.Id == 1)
                    return;
            }
            global.db.Execute("Update CounterData set NextDataId=null where NextDataId=?", lastData.DataId);
            global.db.Delete<CounterData>(lastData.DataId);
            refresh();
        }

        private async void btnChange_Click(object sender, RoutedEventArgs e)
        {
            await Frame.NavigateAsync(typeof(AddData), new AddDataParameter()
            {
                CounterId = id,
                ScoreId = 0,
                DataId = selectedData.DataId
            });
        }

        private async void btnDeleteAll_Click(object sender, RoutedEventArgs e)
        {
            MessageDialog msgbox = new MessageDialog("Вы действительно хотите удалить все показания?");

            msgbox.Commands.Add(new UICommand("Да", c =>
            {
                var firstDataId = datas.First().DataId;
                global.db.Execute("Update CounterData set NextDataId=null where DataId=?", firstDataId);
                global.db.Execute(string.Format("delete from CounterData where CounterId={0} and DataId<>{1}", id, firstDataId));
                refresh();
            }));
            msgbox.Commands.Add(new UICommand("Нет"));
            await msgbox.ShowAsync();
        }
    }
}
